---
import { Send, Globe, ChevronDown, LayoutDashboard, Menu, X } from "lucide-astro";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const languages = [
  { code: "en", name: "English", flag: "ðŸ‡ºðŸ‡¸" },
  { code: "id", name: "Indonesia", flag: "ðŸ‡®ðŸ‡©" },
];

const navItems = [
  {
    label: t("nav.what_we_do"),
    href: "#what-we-do",
    children: [
      { label: t("nav.overview"), href: "#what-we-do", isOverview: true },
      { label: t("services.1.title"), href: "#what-we-do" },
      { label: t("services.2.title"), href: "#what-we-do" },
    ],
  },
  {
    label: t("nav.how_we_work"),
    href: "#how-we-work",
    children: [
      { label: t("nav.approach"), href: "#how-we-work", isOverview: true },
      { label: t("nav.agile"), href: "#how-we-work" },
      { label: t("nav.tools"), href: "#how-we-work" },
    ],
  },
  { label: t("nav.about"), href: "#about" },
  { label: t("nav.article"), href: "/blog" },
  { label: t("nav.contact"), href: "#contact" },
];
---

<header class="fixed top-0 left-0 right-0 z-50 w-full bg-white/80 backdrop-blur-md border-b border-slate-200">
  <nav class="w-full max-w-7xl mx-auto flex justify-between items-center px-6 md:px-8 py-4">
    <!-- Logo -->
    <a href={`/${lang === "id" ? "id" : ""}`} class="flex items-center gap-2 group z-50">
      <div class="p-1.5 bg-brand-primary/10 rounded-lg">
        <LayoutDashboard class="w-6 h-6 text-brand-primary" />
      </div>
      <span class="text-xl font-bold text-slate-900 tracking-tight group-hover:text-brand-primary transition-colors"> RUANJITECH </span>
    </a>

    <!-- Desktop Menu -->
    <div class="hidden md:flex items-center gap-8">
      {
        navItems.map((item) =>
          item.children ? (
            <div class="relative group">
              <button class="flex items-center gap-1 text-sm font-medium text-slate-600 hover:text-brand-primary transition-colors py-2 group-hover:text-brand-primary">
                {item.label}
                <ChevronDown class="w-4 h-4 transition-transform duration-200 group-hover:rotate-180" />
              </button>

              <div class="absolute top-full left-0 mt-2 w-[480px] bg-white rounded-xl shadow-xl border border-slate-100/50 overflow-hidden opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-left translate-y-2 group-hover:translate-y-0 z-50">
                <div class="flex p-2">
                  {/* Left: Overview Button */}
                  <div class="w-1/3 p-1">
                    {item.children
                      .filter((c) => c.isOverview)
                      .map((child) => (
                        <a
                          href={child.href}
                          class="flex h-full flex-col items-center justify-center p-4 rounded-lg bg-slate-50 hover:bg-brand-primary/5 text-slate-700 hover:text-brand-primary transition-all group/overview border border-transparent hover:border-brand-primary/10"
                        >
                          <span class="font-bold text-lg mb-1">{child.label}</span>
                        </a>
                      ))}
                  </div>

                  {/* Divider */}
                  <div class="w-px bg-slate-100 my-2 mx-1" />

                  {/* Right: Sub Items */}
                  <div class="flex-1 p-2 flex flex-col justify-center gap-1">
                    {item.children
                      .filter((c) => !c.isOverview)
                      .map((child) => (
                        <a href={child.href} class="block px-4 py-3 text-sm font-medium text-slate-600 rounded-lg hover:bg-slate-50 hover:text-brand-primary transition-colors">
                          {child.label}
                        </a>
                      ))}
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <a href={item.href} class="text-sm font-medium text-slate-600 hover:text-brand-primary transition-colors relative group">
              {item.label}
              <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-brand-primary transition-all duration-300 group-hover:w-full" />
            </a>
          ),
        )
      }
    </div>

    <!-- Right Side -->
    <div class="hidden md:flex items-center gap-4">
      <!-- Language Selector -->
      <div class="relative group" id="lang-selector">
        <button id="lang-btn" class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors">
          <Globe class="w-4 h-4" />
          <span class="hidden sm:inline text-sm font-medium" id="lang-display">ðŸ‡ºðŸ‡¸ EN</span>
          <ChevronDown class="w-4 h-4 text-slate-400 group-hover:rotate-180 transition-transform" />
        </button>

        <!-- Dropdown -->
        <div class="absolute top-full right-0 mt-2 w-40 bg-white rounded-lg shadow-lg border border-slate-100 overflow-hidden hidden group-hover:block px-1 py-1">
          {
            languages.map((l) => (
              <a href={l.code === "id" ? "/id" : "/"} class={`flex items-center gap-3 px-3 py-2 text-sm rounded-md transition-colors ${lang === l.code ? "bg-brand-primary/5 text-brand-primary" : "text-slate-600 hover:bg-slate-50"}`}>
                <span>{l.flag}</span>
                <span>{l.name}</span>
              </a>
            ))
          }
        </div>
      </div>
    </div>

    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="md:hidden z-50 p-2 text-slate-600 hover:bg-slate-50 rounded-lg">
      <Menu class="w-6 h-6" />
    </button>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="fixed inset-0 bg-white z-40 flex flex-col items-center justify-center gap-8 opacity-0 pointer-events-none transition-all duration-300">
      <button id="close-menu-btn" class="absolute top-6 right-6 p-2 text-slate-600 hover:bg-slate-50 rounded-lg">
        <X class="w-6 h-6" />
      </button>

      {
        navItems.map((item) =>
          item.children ? (
            <div class="text-center">
              <span class="block text-2xl font-bold text-slate-900 mb-4">{item.label}</span>
              <div class="flex flex-col gap-3">
                {item.children.map((child) => (
                  <a href={child.href} class={`text-lg ${child.isOverview ? "font-semibold text-brand-primary" : "text-slate-600"} hover:text-brand-primary transition-colors`}>
                    {child.label}
                  </a>
                ))}
              </div>
            </div>
          ) : (
            <a href={item.href} class="text-2xl font-bold text-slate-900 hover:text-brand-primary transition-colors">
              {item.label}
            </a>
          ),
        )
      }

      <div class="flex gap-4 mt-8">
        {
          languages.map((l) => (
            <a href={l.code === "id" ? "/id" : "/"} class={`flex items-center gap-2 px-4 py-2 rounded-full border ${lang === l.code ? "border-brand-primary text-brand-primary bg-brand-primary/5" : "border-slate-200 text-slate-600"}`}>
              <span>{l.flag}</span>
              <span>{l.name}</span>
            </a>
          ))
        }
      </div>
    </div>
  </nav>
</header>

<script>
  function initMobileMenu() {
    const menuBtn = document.getElementById("mobile-menu-btn");
    const closeBtn = document.getElementById("close-menu-btn");
    const menu = document.getElementById("mobile-menu");
    const links = menu?.querySelectorAll("a");

    function toggleMenu() {
      menu?.classList.toggle("opacity-0");
      menu?.classList.toggle("pointer-events-none");
    }

    menuBtn?.addEventListener("click", toggleMenu);
    closeBtn?.addEventListener("click", toggleMenu);

    links?.forEach((link) => {
      link.addEventListener("click", toggleMenu);
    });
  }

  document.addEventListener("astro:page-load", initMobileMenu);
  // Also run on initial load for non-SPA navigation or first hit
  document.addEventListener("DOMContentLoaded", initMobileMenu);
</script>
